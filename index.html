<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">
        <title>ScrumVote Lite</title>
        <script>
            'use strict';
            const dbApiKey = '6140e5d043cedb6d1f97f126';
            const userDataDbUrl = 'https://svldb-3267.restdb.io/rest/userdata';
            const roomDbUrl = 'https://svldb-3267.restdb.io/rest/rooms';
            let roomId = (new URL(document.location)).searchParams.get('room');

            let userData;
            window.onload = () => {
                userData = JSON.parse(localStorage.getItem('userData') ?? 'null') ?? {
                    name: 'Anonymous',
                    id: Date.now().toString(36) + Math.random().toString(36).substring(2),
                    vote: ''
                };
                document.getElementById('userNameText').placeholder = userData.name;
            };

            async function dbRequest(dbUrl, method, body) {
                return await fetch(dbUrl, { 
                    method: method, 
                    headers: { 
                        'x-apikey': dbApiKey,
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'cache-control': 'no-cache'
                    },
                    body: JSON.stringify(body)
                }).then(r => {
                    if (!r.ok) throw Error(r.status + r.statusText);
                    return r;
                });
            }

            async function onNameInput(userName) {
                userData.name = userName || userData.name;
                localStorage.setItem('userData', JSON.stringify(userData));
                const userNameForm = document.getElementById('userNameForm');
                userNameForm.classList.remove('d-inline');
                userNameForm.classList.add('d-none');
                if (roomId) { // Vote mode
                    const room = await dbRequest(roomDbUrl + `?q={"id":"${roomId}"}`, 'GET');
                    const voteForm = document.getElementById('voteForm');
                    voteForm.classList.remove('d-none');
                    voteForm.classList.add('d-inline');
                    voteForm.innerText = JSON.stringify(room);
                } else { // Room creation mode
                    const createRoomForm = document.getElementById('createRoomForm');
                    createRoomForm.classList.remove('d-none');
                    createRoomForm.classList.add('d-inline');
                }
            }

            async function onQuestionInput(question) {
                const createRoomForm = document.getElementById('createRoomForm');
                createRoomForm.classList.remove('d-inline');
                createRoomForm.classList.add('d-none');
                console.log(userData.id);
                try {
                    await dbRequest(roomDbUrl, 'PUT', { id: userData.id, question: question });
                } catch {
                    await dbRequest(roomDbUrl, 'POST', { id: userData.id, question: question });
                }
                window.location.href = window.location.pathname + `?room=${userData.id}`;
            }
        </script>
    </head>
<body>
    <div class="container">
        <h1><b>ScrumVote Lite</b></h1>
        <form id="userNameForm" class="d-inline" onsubmit="return false">
            <div class="form-group">
                <label for="userNameText">Username:</label>
                <input id="userNameText" type="text" class="form-control" name="userName" placeholder="Anonymous">
            </div>
            <button class="btn btn-primary" onclick="onNameInput(this.form.elements['userName'].value)">Continue</button>
        </form>
        <form id="createRoomForm" class="d-none" onsubmit="return false">
            <div class="form-group">
                <label for="questionText">Question:</label>
                <input id="questionText" type="text" class="form-control" name="question" placeholder="What is the meaning of life?">
            </div>
            <button class="btn btn-primary" onclick="onQuestionInput(this.form.elements['question'].value)">Create</button>
        </form>
        <form id="voteForm" class="d-none">
            lfsz
        </form>
    </div>
</body>
</html>